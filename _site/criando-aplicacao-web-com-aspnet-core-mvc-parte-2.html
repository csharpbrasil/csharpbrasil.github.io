<!DOCTYPE html>
<html>

<head>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-T668JSDW');</script>
    <!-- End Google Tag Manager -->

	<!-- Meta -->
	<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Criando aplicação Web com ASP.NET Core MVC – Parte 2 | C# Brasil</title>
<meta name="generator" content="Jekyll v3.9.5" />
<meta property="og:title" content="Criando aplicação Web com ASP.NET Core MVC – Parte 2" />
<meta name="author" content="Raphael Cardoso" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Resumo" />
<meta property="og:description" content="Resumo" />
<link rel="canonical" href="http://localhost:4000/criando-aplicacao-web-com-aspnet-core-mvc-parte-2" />
<meta property="og:url" content="http://localhost:4000/criando-aplicacao-web-com-aspnet-core-mvc-parte-2" />
<meta property="og:site_name" content="C# Brasil" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-05-30T08:00:19-03:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Criando aplicação Web com ASP.NET Core MVC – Parte 2" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Raphael Cardoso","url":"http://www.csharpbrasil.com.br"},"dateModified":"2019-05-30T08:00:19-03:00","datePublished":"2019-05-30T08:00:19-03:00","description":"Resumo","headline":"Criando aplicação Web com ASP.NET Core MVC – Parte 2","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/criando-aplicacao-web-com-aspnet-core-mvc-parte-2"},"url":"http://localhost:4000/criando-aplicacao-web-com-aspnet-core-mvc-parte-2"}</script>
<!-- End Jekyll SEO tag -->


	<!-- CSS & fonts -->
	<link rel="stylesheet" href="/css/main.css?1717257970198203784">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,300,600,800" rel="stylesheet" type="text/css">

    <link rel="shortcut icon" href="/images/favicon.png" />
</head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NS9JFVVY3Z"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-NS9JFVVY3Z');
</script>

<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T668JSDW"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

	<div id="wrap">
	  	
    <!-- Navigation -->
    <nav id="nav">
	<div id="nav-list">
		<a href="http://localhost:4000/">Página inicial</a>
		<a href="http://localhost:4000/sobre">Sobre o blog</a>
	</div>
</nav>

    
    <!-- Icon menu -->
	  <a id="nav-menu">
	  	<div id="menu"></div>
	  </a>
    <!-- Header -->
    <header id="header">
	<a href="http://localhost:4000/">
		<img src="/images/logo_csharpbrasil.png" class="logo" alt="C# Brasil">
	</a>
</header>

    <!-- Main content -->
	  <div id="container">
      <main>
        <article id="post-page">
	<h2>Criando aplicação Web com ASP.NET Core MVC – Parte 2</h2>		
	<time datetime="2019-05-30T08:00:19-03:00" class="by-line">
		
		30
		Maio
		  
		2019
	</time>
	<div class="content">

		<h2 id="resumo">Resumo</h2>

<p>Na primeira parte dessa série de artigos, iniciamos explicando o significado da sigla MVC e sobre o ASP.NET Core para depois abordamos sobre as caracteristicas do nosso projeto e dar início ao desenvolvimento.</p>

<p>Você vai ver ainda ao logo dessa série assuntos variados para que possamos enriquecer nosso projeto com funcionalidades bem úteis. Ainda poderemos fazer uma breve abordagem sobre segurança e testes unitários.</p>

<p>Então, vamos ao que interessa.</p>

<h3 id="continuando-o-desenvolvimento">Continuando o desenvolvimento</h3>

<p>Para dar continuidade ao projeto, será necessario que você faça o download do fonte que está disponibilizado no <a href="https://github.com/csharpbrasil/CriandoAplicacaoAspNetCore">Github</a>.</p>

<h4 id="consulta-de-usuários">Consulta de usuários</h4>

<p>Após autenticar no painel adminitrativo, a primeira visão que o usuário terá é do menu superior com algumas funcionalidades do painel e dentre elas, vamos disponibilizar uma área que permita-nos gerenciar os usuários cadastrados.</p>

<p>Normalmente em um sistema usamos permissão para essas ações, mas a principio, qualquer usuário que tiver acesso ao painel, poderá editar e utilizar todas as funcionalidades existentes.</p>

<p><img src="/contents/2019/05/1_painel_administrativo-1024x553.png" alt="" /></p>

<p>Dando sequencia em nosso projeto, vamos criar a tela onde iremos consultar os usuários cadastrados. Para isso, incluiremos um novo controle na area do painel.</p>

<p><img src="/contents/2019/05/novo_controller.png" alt="" /></p>

<p>Definaremos o nome como UsuarioController.</p>

<p><img src="/contents/2019/05/novo_controller_usuario.png" alt="" /></p>

<p>E incluiremos a consulta para listar todos os usuários cadastrados.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">CriandoAplicacaoAspNetCore.Model.Dtos</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">CriandoAplicacaoAspNetCore.Model.Interfaces</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Authorization</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Mvc</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">CriandoAplicacaoAspNetCore.WebApp.Areas.Painel.Controllers</span>
<span class="p">{</span>
    <span class="p">[</span><span class="nf">Area</span><span class="p">(</span><span class="s">"Painel"</span><span class="p">)]</span>
    <span class="p">[</span><span class="n">Authorize</span><span class="p">]</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">UsuarioController</span> <span class="p">:</span> <span class="n">Controller</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IUsuarioBusiness</span> <span class="n">_usuarioBusiness</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">UsuarioController</span><span class="p">(</span><span class="n">IUsuarioBusiness</span> <span class="n">usuarioBusiness</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="n">_usuarioBusiness</span> <span class="p">=</span> <span class="n">usuarioBusiness</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">Consultar</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">usuarios</span> <span class="p">=</span> <span class="n">_usuarioBusiness</span><span class="p">.</span><span class="nf">Filtrar</span><span class="p">();</span>

            <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="n">usuarios</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Criaremos também a view referente a tela de consulta de usuários.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">@model</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">CriandoAplicacaoAspNetCore</span><span class="p">.</span><span class="n">Model</span><span class="p">.</span><span class="n">Dtos</span><span class="p">.</span><span class="n">UsuarioDto</span><span class="p">&gt;</span>
<span class="err">@</span><span class="p">{</span>
    <span class="n">ViewData</span><span class="p">[</span><span class="s">"Title"</span><span class="p">]</span> <span class="p">=</span> <span class="s">"Usuários"</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">&lt;</span><span class="n">div</span> <span class="k">class</span><span class="err">="</span><span class="nc">row</span><span class="s">"&gt;
</span>    <span class="p">&lt;</span><span class="n">div</span> <span class="k">class</span><span class="err">="</span><span class="nc">col</span><span class="s">"&gt;
</span>        <span class="p">&lt;</span><span class="n">h2</span> <span class="k">class</span><span class="err">="</span><span class="nc">display</span><span class="p">-</span><span class="m">4</span><span class="s">"&gt;Consultar Usuários&lt;/h2&gt;
</span>    <span class="p">&lt;/</span><span class="n">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="n">div</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="n">div</span> <span class="k">class</span><span class="err">="</span><span class="nc">row</span> <span class="n">mt</span><span class="p">-</span><span class="m">4</span> <span class="n">mb</span><span class="p">-</span><span class="m">4</span><span class="s">"&gt;
</span>    <span class="p">&lt;</span><span class="n">div</span> <span class="k">class</span><span class="err">="</span><span class="nc">col</span><span class="s">"&gt;
</span>        <span class="p">&lt;</span><span class="n">a</span> <span class="k">class</span><span class="err">="</span><span class="nc">btn</span> <span class="n">btn</span><span class="p">-</span><span class="n">primary</span><span class="s">" asp-area="</span><span class="n">Painel</span><span class="s">" asp-controller="</span><span class="n">Usuario</span><span class="s">" asp-action="</span><span class="n">Novo</span><span class="s">"&gt;&lt;i class="</span><span class="n">fas</span> <span class="n">fa</span><span class="p">-</span><span class="n">plus</span><span class="p">-</span><span class="n">circle</span><span class="s">"&gt;&lt;/i&gt; Novo&lt;/a&gt;
</span>    <span class="p">&lt;/</span><span class="n">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="n">div</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="n">div</span> <span class="k">class</span><span class="err">="</span><span class="nc">row</span><span class="s">"&gt;
</span>    <span class="p">&lt;</span><span class="n">div</span> <span class="k">class</span><span class="err">="</span><span class="nc">col</span><span class="s">"&gt;
</span>        <span class="p">&lt;</span><span class="n">table</span> <span class="k">class</span><span class="err">="</span><span class="nc">table</span> <span class="n">table</span><span class="p">-</span><span class="n">striped</span> <span class="n">table</span><span class="p">-</span><span class="n">bordered</span> <span class="n">table</span><span class="p">-</span><span class="n">hover</span><span class="s">"&gt;
</span>            <span class="p">&lt;</span><span class="n">thead</span> <span class="k">class</span><span class="err">="</span><span class="nc">thead</span><span class="p">-</span><span class="n">dark</span><span class="s">"&gt;
</span>                <span class="p">&lt;</span><span class="n">tr</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="n">th</span> <span class="n">scope</span><span class="p">=</span><span class="s">"col"</span><span class="p">&gt;</span><span class="err">#</span><span class="p">&lt;/</span><span class="n">th</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="n">th</span> <span class="n">scope</span><span class="p">=</span><span class="s">"col"</span><span class="p">&gt;</span><span class="n">Nome</span><span class="p">&lt;/</span><span class="n">th</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="n">th</span> <span class="n">scope</span><span class="p">=</span><span class="s">"col"</span><span class="p">&gt;</span><span class="n">Login</span><span class="p">&lt;/</span><span class="n">th</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="n">th</span> <span class="n">scope</span><span class="p">=</span><span class="s">"col"</span><span class="p">&gt;</span><span class="n">Email</span><span class="p">&lt;/</span><span class="n">th</span><span class="p">&gt;</span>
                <span class="p">&lt;/</span><span class="n">tr</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="n">thead</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="n">tbody</span><span class="p">&gt;</span>
                <span class="nf">@foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">item</span> <span class="k">in</span> <span class="n">Model</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="p">&lt;</span><span class="n">tr</span><span class="p">&gt;</span>
                        <span class="p">&lt;</span><span class="n">th</span> <span class="n">scope</span><span class="p">=</span><span class="s">"row"</span><span class="p">&gt;</span>
                            <span class="p">&lt;</span><span class="n">a</span> <span class="k">class</span><span class="err">="</span><span class="nc">btn</span> <span class="n">btn</span><span class="p">-</span><span class="n">info</span> <span class="n">btn</span><span class="p">-</span><span class="n">sm</span><span class="s">" asp-area="</span><span class="n">Painel</span><span class="s">" asp-controller="</span><span class="n">Usuario</span><span class="s">" asp-action="</span><span class="n">Editar</span><span class="s">" asp-route-id="</span><span class="n">@item</span><span class="p">.</span><span class="n">IdUsuario</span><span class="s">"&gt;&lt;i class="</span><span class="n">fas</span> <span class="n">fa</span><span class="p">-</span><span class="n">pen</span><span class="p">-</span><span class="n">alt</span><span class="s">"&gt;&lt;/i&gt;&lt;/a&gt;
</span>                            <span class="p">&lt;</span><span class="n">a</span> <span class="k">class</span><span class="err">="</span><span class="nc">btn</span> <span class="n">btn</span><span class="p">-</span><span class="n">danger</span> <span class="n">btn</span><span class="p">-</span><span class="n">sm</span><span class="s">" asp-area="</span><span class="n">Painel</span><span class="s">" asp-controller="</span><span class="n">Usuario</span><span class="s">" asp-action="</span><span class="n">Excluir</span><span class="s">" asp-route-id="</span><span class="n">@item</span><span class="p">.</span><span class="n">IdUsuario</span><span class="s">"&gt;&lt;i class="</span><span class="n">fas</span> <span class="n">fa</span><span class="p">-</span><span class="n">trash</span><span class="p">-</span><span class="n">alt</span><span class="s">"&gt;&lt;/i&gt;&lt;/a&gt;
</span>                        <span class="p">&lt;/</span><span class="n">th</span><span class="p">&gt;</span>
                        <span class="p">&lt;</span><span class="n">td</span><span class="p">&gt;</span><span class="n">@item</span><span class="p">.</span><span class="n">Nome</span><span class="p">&lt;/</span><span class="n">td</span><span class="p">&gt;</span>
                        <span class="p">&lt;</span><span class="n">td</span><span class="p">&gt;</span><span class="n">@item</span><span class="p">.</span><span class="n">Login</span><span class="p">&lt;/</span><span class="n">td</span><span class="p">&gt;</span>
                        <span class="p">&lt;</span><span class="n">td</span><span class="p">&gt;</span><span class="n">@item</span><span class="p">.</span><span class="n">Email</span><span class="p">&lt;/</span><span class="n">td</span><span class="p">&gt;</span>
                    <span class="p">&lt;/</span><span class="n">tr</span><span class="p">&gt;</span>
                <span class="p">}</span>
            <span class="p">&lt;/</span><span class="n">tbody</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="n">table</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="n">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="n">div</span><span class="p">&gt;</span>
</code></pre></div></div>

<p>Ao executar nosso projeto, teremos agora a lista de todos os usuários cadastrados.</p>

<p><img src="/contents/2019/05/consulta_usuarios-1024x553.png" alt="" /></p>

<h4 id="melhorando-a-segurança">Melhorando a segurança</h4>

<p>Se reparar, a nossa senha esta armazenada de forma que qualquer um que tenha acesso ao nosso banco de dados poderá visualiza-la.</p>

<p><img src="/contents/2019/05/senha_banco.png" alt="" /></p>

<p>Para melhorar a segurança, não vamos mais armazenar nossa senha, mas sim o hash.</p>

<p>Criaremos um novo projeto contendo nosso <strong><em>SecurityManager.cs</em></strong> que será responsável por criar e validar nosso hash.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Cryptography.KeyDerivation</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Security.Cryptography</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">CriandoAplicacaoAspNetCore.Utils</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">SecurityManager</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">ITERATION_COUNT</span> <span class="p">=</span> <span class="m">10000</span><span class="p">;</span>

        <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">CreateSalt</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">generator</span> <span class="p">=</span> <span class="n">RandomNumberGenerator</span><span class="p">.</span><span class="nf">Create</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="kt">byte</span><span class="p">[]</span> <span class="n">randomBytes</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="m">128</span> <span class="p">/</span> <span class="m">8</span><span class="p">];</span>
                <span class="n">generator</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="n">randomBytes</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">Convert</span><span class="p">.</span><span class="nf">ToBase64String</span><span class="p">(</span><span class="n">randomBytes</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">CreateHash</span><span class="p">(</span><span class="kt">string</span> <span class="k">value</span><span class="p">,</span> <span class="kt">string</span> <span class="n">salt</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">valueBytes</span> <span class="p">=</span> <span class="n">KeyDerivation</span><span class="p">.</span><span class="nf">Pbkdf2</span><span class="p">(</span><span class="n">password</span><span class="p">:</span> <span class="k">value</span><span class="p">,</span> <span class="n">salt</span><span class="p">:</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="n">salt</span><span class="p">),</span>
                                                  <span class="n">prf</span><span class="p">:</span> <span class="n">KeyDerivationPrf</span><span class="p">.</span><span class="n">HMACSHA512</span><span class="p">,</span> <span class="n">iterationCount</span><span class="p">:</span> <span class="n">ITERATION_COUNT</span><span class="p">,</span>
                                                  <span class="n">numBytesRequested</span><span class="p">:</span> <span class="m">256</span> <span class="p">/</span> <span class="m">8</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">Convert</span><span class="p">.</span><span class="nf">ToBase64String</span><span class="p">(</span><span class="n">valueBytes</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">Validate</span><span class="p">(</span><span class="kt">string</span> <span class="k">value</span><span class="p">,</span> <span class="kt">string</span> <span class="n">salt</span><span class="p">,</span> <span class="kt">string</span> <span class="n">hash</span><span class="p">)</span>
            <span class="p">=&gt;</span> <span class="nf">CreateHash</span><span class="p">(</span><span class="k">value</span><span class="p">,</span> <span class="n">salt</span><span class="p">)</span> <span class="p">==</span> <span class="n">hash</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span> 
</code></pre></div></div>

<p>E agora vamos alterar a autenticação do usuário para que ele passe a fazer uso da validação pelo hash.</p>

<p>Primeiro, vamos remover a coluna de <strong><em>Senha</em></strong> e criar as Colunas para o <em><strong>Hash</strong></em> e outra para p <strong><em>Salt</em></strong>.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">Usuario</span> <span class="k">DROP</span> <span class="k">COLUMN</span> <span class="n">Senha</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">usuario</span> <span class="k">ADD</span> <span class="n">Hash</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">usuario</span> <span class="k">ADD</span> <span class="n">Salt</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
</code></pre></div></div>

<p>E atualizaremos a senha do usuário <em><strong>Admin</strong></em> para a senha padrão <em><strong>123456</strong></em>, porém, será armazenado somente o Hash e o Salt. Não teremos mais a senha gravada.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">UPDATE</span> <span class="n">Usuario</span> <span class="k">SET</span> <span class="n">Hash</span> <span class="o">=</span> <span class="s1">'NLAZBttBU8HbUrODUPQxViEDr1d7RMi4B/2F6yaKOrQ='</span><span class="p">,</span> <span class="n">Salt</span> <span class="o">=</span> <span class="s1">'Nkt8krN4/TBHUJXu4zEm6A=='</span> 
<span class="k">WHERE</span> <span class="n">Login</span> <span class="o">=</span> <span class="s1">'admin'</span>
</code></pre></div></div>

<p><img src="/contents/2019/05/hash_salt_banco.png" alt="" /></p>

<p>Atualizaremos a entidade Usuario e a configuração do Entity Framework.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">namespace</span> <span class="nn">CriandoAplicacaoAspNetCore.Model.Entities</span>
<span class="p">{</span>
	<span class="k">public</span> <span class="k">class</span> <span class="nc">Usuario</span>
	<span class="p">{</span>
		<span class="k">public</span> <span class="k">virtual</span> <span class="kt">int</span> <span class="n">IdUsuario</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
		<span class="k">public</span> <span class="k">virtual</span> <span class="kt">string</span> <span class="n">Nome</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
		<span class="k">public</span> <span class="k">virtual</span> <span class="kt">string</span> <span class="n">Email</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
		<span class="k">public</span> <span class="k">virtual</span> <span class="kt">string</span> <span class="n">Login</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
		<span class="k">public</span> <span class="k">virtual</span> <span class="kt">string</span> <span class="n">Hash</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
		<span class="k">public</span> <span class="k">virtual</span> <span class="kt">string</span> <span class="n">Salt</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span> 
</code></pre></div></div>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">CriandoAplicacaoAspNetCore.Model.Entities</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.EntityFrameworkCore</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.EntityFrameworkCore.Metadata.Builders</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">CriandoAplicacaoAspNetCore.Data.Mapping</span>
<span class="p">{</span>
	<span class="k">public</span> <span class="k">class</span> <span class="nc">UsuarioConfig</span> <span class="p">:</span> <span class="n">IEntityTypeConfiguration</span><span class="p">&lt;</span><span class="n">Usuario</span><span class="p">&gt;</span>
	<span class="p">{</span>
		<span class="k">public</span> <span class="k">void</span> <span class="nf">Configure</span><span class="p">(</span><span class="n">EntityTypeBuilder</span><span class="p">&lt;</span><span class="n">Usuario</span><span class="p">&gt;</span> <span class="n">builder</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">builder</span><span class="p">.</span><span class="nf">ToTable</span><span class="p">(</span><span class="s">"Usuario"</span><span class="p">);</span>
			<span class="n">builder</span><span class="p">.</span><span class="nf">HasKey</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="n">t</span><span class="p">.</span><span class="n">IdUsuario</span><span class="p">);</span>
			<span class="n">builder</span><span class="p">.</span><span class="nf">Property</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="n">t</span><span class="p">.</span><span class="n">IdUsuario</span><span class="p">);</span>
			<span class="n">builder</span><span class="p">.</span><span class="nf">Property</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="n">t</span><span class="p">.</span><span class="n">Nome</span><span class="p">);</span>
			<span class="n">builder</span><span class="p">.</span><span class="nf">Property</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="n">t</span><span class="p">.</span><span class="n">Email</span><span class="p">);</span>
			<span class="n">builder</span><span class="p">.</span><span class="nf">Property</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="n">t</span><span class="p">.</span><span class="n">Login</span><span class="p">);</span>
			<span class="n">builder</span><span class="p">.</span><span class="nf">Property</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="n">t</span><span class="p">.</span><span class="n">Hash</span><span class="p">);</span>
			<span class="n">builder</span><span class="p">.</span><span class="nf">Property</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="n">t</span><span class="p">.</span><span class="n">Salt</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Agora vamos alterar a autenticação do usuário para que seja validado atraves do hash.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">CriandoAplicacaoAspNetCore.Model.Dtos</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">CriandoAplicacaoAspNetCore.Model.Interfaces</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">CriandoAplicacaoAspNetCore.Utils</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">CriandoAplicacaoAspNetCore.Business</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">UsuarioBusiness</span> <span class="p">:</span> <span class="n">IUsuarioBusiness</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IUnitOfWork</span> <span class="n">_unitOfWork</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">UsuarioBusiness</span><span class="p">(</span><span class="n">IUnitOfWork</span> <span class="n">unitOfWork</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="n">_unitOfWork</span> <span class="p">=</span> <span class="n">unitOfWork</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">virtual</span> <span class="n">UsuarioDto</span> <span class="nf">Autenticar</span><span class="p">(</span><span class="n">LoginDto</span> <span class="n">loginDto</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">usuario</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">_unitOfWork</span>
                <span class="p">.</span><span class="n">UsuarioRepository</span>
                <span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="n">q</span> <span class="p">=&gt;</span> <span class="n">q</span><span class="p">.</span><span class="n">Login</span><span class="p">.</span><span class="nf">ToLower</span><span class="p">().</span><span class="nf">Equals</span><span class="p">(</span><span class="n">loginDto</span><span class="p">.</span><span class="n">Usuario</span><span class="p">))</span>
                <span class="p">.</span><span class="nf">FirstOrDefault</span><span class="p">();</span>

            <span class="k">if</span> <span class="p">(!</span><span class="n">SecurityManager</span><span class="p">.</span><span class="nf">Validate</span><span class="p">(</span><span class="n">loginDto</span><span class="p">.</span><span class="n">Senha</span><span class="p">,</span> <span class="n">usuario</span><span class="p">.</span><span class="n">Salt</span><span class="p">,</span> <span class="n">usuario</span><span class="p">.</span><span class="n">Hash</span><span class="p">))</span>
                <span class="k">return</span> <span class="k">null</span><span class="p">;</span>

            <span class="k">return</span> <span class="k">new</span> <span class="n">UsuarioDto</span>
            <span class="p">{</span>
                <span class="n">IdUsuario</span> <span class="p">=</span> <span class="n">usuario</span><span class="p">.</span><span class="n">IdUsuario</span><span class="p">,</span>
                <span class="n">Nome</span> <span class="p">=</span> <span class="n">usuario</span><span class="p">.</span><span class="n">Nome</span><span class="p">,</span>
                <span class="n">Email</span> <span class="p">=</span> <span class="n">usuario</span><span class="p">.</span><span class="n">Email</span><span class="p">,</span>
                <span class="n">Login</span> <span class="p">=</span> <span class="n">usuario</span><span class="p">.</span><span class="n">Login</span>
            <span class="p">};</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">UsuarioDto</span><span class="p">&gt;</span> <span class="nf">Filtrar</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">query</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">_unitOfWork</span>
                <span class="p">.</span><span class="n">UsuarioRepository</span>
                <span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="nf">OrderBy</span><span class="p">(</span><span class="n">u</span> <span class="p">=&gt;</span> <span class="n">u</span><span class="p">.</span><span class="n">Nome</span><span class="p">))</span>
                <span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">UsuarioDto</span>
                <span class="p">{</span>
                    <span class="n">IdUsuario</span> <span class="p">=</span> <span class="n">s</span><span class="p">.</span><span class="n">IdUsuario</span><span class="p">,</span>
                    <span class="n">Nome</span> <span class="p">=</span> <span class="n">s</span><span class="p">.</span><span class="n">Nome</span><span class="p">,</span>
                    <span class="n">Email</span> <span class="p">=</span> <span class="n">s</span><span class="p">.</span><span class="n">Email</span><span class="p">,</span>
                    <span class="n">Login</span> <span class="p">=</span> <span class="n">s</span><span class="p">.</span><span class="n">Login</span>
                <span class="p">});</span>
            <span class="k">return</span> <span class="n">query</span><span class="p">.</span><span class="nf">ToList</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Feito isso, o usuário passará a se autenticar informando a senha, porém para validar será necessário buscar o usuário no banco de dados, pegar a senha informada juntamente com o Hash e o Salt para validar.</p>

<p>Dessa forma garantimos que mesmo que um usuário mal intensionado tenha acesso ao banco de dados e consiga roubar o hash e o salt, não teria como ter acesso ao sistema por não ter a senha do usuário e para descobrir a senha.</p>

<p>Em caso de o usuário esquecer a senha, será necessário resetar a senha, gerando uma nova aleatória para que ele possa alterar em outro momeno. No caso de ele necessitar alterar a senha, será necessário que ele informe a senha atual e informa nova senha. Mas essa será uma implementação futura.</p>

<h4 id="inclusão-edição-e-exclusão-de-usuários">Inclusão, edição e exclusão de usuários</h4>

<p>Agora para completar a funcionalidade de cadastro de usuários, será necessário criar o formulário para inclusão e edição de usuários, além da opção para exclusão.</p>

<p>Seguindo os passos anteriores, vamos criar uma nova View.</p>

<p><img src="/contents/2019/05/nova_view_salvar.png" alt="" /></p>

<p>Teremos uma view para listar a Consulta de Usuários e uma View para Salvar. Essa view de Salvar, será usado tanto para Novo quanto para edição. O detalhe é que para Novo, teremos o campo senha sendo exibido, já na edição, não iremos editar a senha.</p>

<p><img src="/contents/2019/05/1_novo_usuario-1024x553.png" alt="" /></p>

<p>Tela de cadastro de usuário</p>

<p>Não me preocupei muito com valiação dos campos. A principio iremos nos preocupar em criar as funcionalidades.</p>

<p>Teremos também a tela de edição de usuário.</p>

<p><img src="/contents/2019/05/1_editar_usuario-1024x553.png" alt="" /></p>

<p>Em ambas as funcionalidades, iremos utilizar o <a href="http://bootboxjs.com/">Bootbox</a>, biblioteca que facilitar a criação de modal utilizando o <a href="https://getbootstrap.com/">Bootstrap</a>.</p>

<p><img src="/contents/2019/05/1_editar_usuario_mensagem_sucesso-1024x553.png" alt="" /></p>

<p>Para a exclusão, iremos fazer uso do bootbox para informar ao usuário sobre a ação que ele esta executando e permitir que ele escolha continuar ou não.</p>

<p><img src="/contents/2019/05/1_excluir_usuario-1024x553.png" alt="" /></p>

<p>E o usuário é alertado sobre a execução que acabou de ser realizada, dando a opção para ele clicar no botão <em>OK</em> e regarregar a página de consulta de usuários.</p>

<p><img src="/contents/2019/05/1_usuario_excluido_sucesso-1024x553.png" alt="" /></p>

<p>Com isso temos a nossa funcionalidade de cadastro de usuários praticamente pronto. É claro que poderiamos colocar validações dos campos, opção para checar se o login já esta cadastrado e até dar opção para que o usuário possa alterar a senha. Mas deixaremos essas funcionalidades para uma outra ocasião.</p>

<p>Para os próximos artigos, iremos abordar a implementação de algumas outras funcionalidades ou até quem sabe melhorias das atuais.</p>

<p>Caso tenha alguma dúvida ou sugestão, pode mandar para mim.</p>

<h4 id="referências">Referências</h4>

<ul>
  <li><a href="https://docs.microsoft.com/pt-br/aspnet/core/mvc/views/layout">Layout no ASP.NET Core</a></li>
  <li><a href="https://docs.microsoft.com/pt-br/aspnet/core/mvc/views/tag-helpers/built-in">Auxiliares de marcação internos do ASP.NET Core</a></li>
  <li><a href="https://docs.microsoft.com/pt-br/aspnet/core/mvc/views/razor">Referência da sintaxe Razor para ASP.NET Core</a></li>
  <li><a href="https://docs.microsoft.com/pt-br/aspnet/core/security/data-protection/consumer-apis/password-hashing">Hash de senhas no ASP.NET Core</a></li>
  <li><a href="http://bootboxjs.com/">Bootbox.js</a></li>
</ul>

<h4 id="fonte-do-projeto">Fonte do projeto</h4>

<p>Fonte do projeto: <a href="https://github.com/csharpbrasil/CriandoAplicacaoAspNetCore">Github</a>.</p>

<p>Abraço e bom estudo!</p>

		
	</div>
	<div id="fb-root"></div>
<script async defer crossorigin="anonymous" src="https://connect.facebook.net/pt_BR/sdk.js#xfbml=1&version=v20.0" nonce="T10lHT3x"></script>
<div class="fb-comments" data-href="http://localhost:4000/criando-aplicacao-web-com-aspnet-core-mvc-parte-2" data-width="" data-numposts="10"></div>


</article>


      </main>		
      <!-- Pagination links -->
      
	  </div>
    
    <!-- Footer -->
    <footer class="footer"><span>&copy; 2024 C# Brasil. Todos os direitos reservados | Versão: 1.0.0 </span></footer>
    <!-- Script -->
    <script src="/js/main.js"></script>	

	</div>
</body>
</html>
