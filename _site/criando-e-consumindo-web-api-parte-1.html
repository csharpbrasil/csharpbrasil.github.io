<!DOCTYPE html>
<html>

<head>
	<!-- Meta -->
	<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="C# Brasil">

	<title>Criando e consumindo Web API - Parte 1</title>

	<!-- CSS & fonts -->
	<link rel="stylesheet" href="/css/main.css?1716937206294534819">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,300,600,800" rel="stylesheet" type="text/css">

    <link rel="shortcut icon" href="/images/favicon.png" />
</head>


<body>
	<div id="wrap">
	  	
    <!-- Navigation -->
    <nav id="nav">
	<div id="nav-list">
		<a href="http://localhost:4000/">Página inicial</a>
		<a href="http://localhost:4000/sobre">Sobre o blog</a>
	</div>
</nav>

    
    <!-- Icon menu -->
	  <a id="nav-menu">
	  	<div id="menu"></div>
	  </a>
    <!-- Header -->
    <header id="header">
	<a href="http://localhost:4000/">
		<img src="/images/logo_csharpbrasil.png" class="logo" alt="C# Brasil">
	</a>
</header>

    <!-- Main content -->
	  <div id="container">
      <main>
        <article id="post-page">
	<h2>Criando e consumindo Web API - Parte 1</h2>		
	<time datetime="2015-06-22T07:30:05-03:00" class="by-line">
		
		22
		Junho
		  
		2015
	</time>
	<div class="content">

		<p>Antes de iniciar o desenvolvimento de uma Web API é importante entender o que é, qual a sua finalidade e a forma como ela funciona.</p>

<p>Para quem não conhece, uma Web API é um conjunto definido de mensagens de requisição e resposta HTTP, geralmente expressado nos formatos XML ou JSON.</p>

<p>Todos nós já tivemos contato de alguma forma com um serviço desse tipo, seja algum site que utilize no dia-a-dia, ou em um dos nossos aplicativos favoritos instalados no smartphone ou tablet. Um exemplo desses aplicativos são o Facebook, Twitter, Linkedin e até jogos utilizam-se de Web API. Então, se está planejando criar algum projeto novo, talvez esse seja um caminho a se analisar.</p>

<p>Para que você entenda melhor o funcionamento de uma Web API, vamos descrever de forma simples um cenário de funcionamento de Web API, como por exemplo a utilizada pelo seu aplicativo do Facebook. Considerando que ele está instalado em seu smartphone:</p>

<ul>
  <li>
    <p>Você informa seus dados de login</p>
  </li>
  <li>O aplicativo grava localmente os dados e envia-os a um servidor de autenticação para geração do Token</li>
  <li>Caso os dados sejam validos, é retornado o token para o aplicativo</li>
  <li>Para realizar a consulta dos post de sua linha, o aplicativo requisita as informações ao servidor utilizando o token para validação</li>
</ul>

<p>Veja abaixo de forma ilustrada como funciona basicamente a requisição, a autenticação e retorno dos dados para o usuário.</p>

<p><img src="https://raphaelcardoso.com.br/wp-content/uploads/2015/06/autenticacao_web_api.png" alt="Autenticaçãoo Web API" /></p>

<p>Para conhecer mais sobre o detalhes do funcionamento do Web API, indico o <a href="http://israelaece.com/post/e-Book-Introducao-ao-ASPNET-Web-API.aspx">e-Book do Israel Aece</a> que alem de gratuito possui um excelente conteúdo para aprendizado.</p>

<p>Iniciaremos então a criação de um novo projeto, para isso, indico o uso do <a href="https://www.visualstudio.com/">Visual Studio Community 2013</a> que alem de completo também é gratuito.</p>

<p>Primeiramente, abra o Visual Studio e clique nome menu <em>File &gt; New &gt; Project</em> e crie um novo projeto web utilizando o template <strong>ASP.NET Web Application</strong> e utilizando o <strong>.NET Framework 4.5</strong>. Defina um nome e caminho para ele. No meu caso, simplesmente se chamara <strong>ProjetoAspNetWebApi</strong>.</p>

<p><img src="https://raphaelcardoso.com.br/wp-content/uploads/2015/06/criando_e_consumindo_webapi_001.png" alt="criando_e_consumindo_webapi_001" /></p>

<p>Após clicar em OK para confirmar, uma nova janela é exibida para selecionar detalhes de nosso ASP.NET Web Application. Nele é possível definirmos templates do tipo WebForms, MVC, Web API, Single Page Application, Azure Mobile Service e Empty. No nosso caso selecionaremos o template Empty para que possamos adicionar somente as bibliotecas e estrutura que são realmente necessários para nosso projeto.</p>

<p><img src="https://raphaelcardoso.com.br/wp-content/uploads/2015/06/criando_e_consumindo_webapi_002.png" alt="criando_e_consumindo_webapi_002" /></p>

<p>Feito isso, agora vamos a lista de bibliotecas necessárias:</p>

<ul>
  <li><strong><a href="https://www.nuget.org/packages/DotNetZip/">DotNetZip</a>:</strong> Biblioteca de compressão;</li>
  <li><strong><a href="https://www.nuget.org/packages/Microsoft.AspNet.Cors/">Microsoft.AspNet.Cors</a>:</strong> Biblioteca que permitir Cross-Origin Resource Sharing (CORS) em ASP.NET;</li>
  <li><strong><a href="https://www.nuget.org/packages/Microsoft.AspNet.WebApi.Client/">Microsoft.AspNet.WebApi.Client</a>:</strong> Biblioteca que adiciona suporte para formatação de conteúdo para System.Net.Http incluindo suporte para JSON e XML;</li>
  <li><strong><a href="https://www.nuget.org/packages/Microsoft.AspNet.WebApi.Core/">Microsoft.AspNet.WebApi.Core</a>:</strong> Biblioteca que contém o core para ASP.NET API Web;</li>
  <li><strong><a href="https://www.nuget.org/packages/Microsoft.AspNet.WebApi.Owin/">Microsoft.AspNet.WebApi.Owin</a>:</strong> Biblioteca que permite a hospedagem de ASP.NET Web API dentro de um servidor Owin e fornece acesso a recursos adicionais.</li>
  <li><strong><a href="https://www.nuget.org/packages/Microsoft.Bcl/">Microsoft.Bcl</a>:</strong> Biblioteca com componentes adicionais;</li>
  <li><strong><a href="https://www.nuget.org/packages/Microsoft.Bcl.Build/">Microsoft.Bcl.Build</a>:</strong> Biblioteca com componentes adicionais;</li>
  <li><strong><a href="https://www.nuget.org/packages/Microsoft.Bcl.Compression/">Microsoft.Bcl.Compression</a>:</strong> Biblioteca que permite a projetos voltados diretamente para Windows Phone Silverligth 8 ou usando bibliotecas portaveis usem as classes ZipArchive, GZipStream e DeflateStream;</li>
  <li><strong><a href="https://www.nuget.org/packages/Microsoft.Net.Http">Microsoft.Net.Http</a>:</strong> Biblioteca que inclui HttpClient para envio de pedidos através de HTTP, bem como HttpRequestMessage e HttpResponseMessage para o processamento de mensagens HTTP;</li>
  <li><strong><a href="https://www.nuget.org/packages/Microsoft.Owin/">Microsoft.Owin</a>:</strong> Biblioteca que fornece um conjunto de componentes para auxiliar e simplificar a criação de componentes Owin;</li>
  <li><strong><a href="https://www.nuget.org/packages/Microsoft.Owin.Cors/">Microsoft.Owin.Cors</a>:</strong> Biblioteca que contém os componentes para habilitar o Cross-Origin Resource Sharing (CORS);</li>
  <li><strong><a href="https://www.nuget.org/packages/Microsoft.Owin.Host.SystemWeb/">Microsoft.Owin.Host.SystemWeb</a>:</strong> Biblioteca do servidor Owin que permite que aplicativos baseados em Owin sejam executados no IIS usando o pipeline de solicitação do ASP.NET;</li>
  <li><strong><a href="https://www.nuget.org/packages/Microsoft.Owin.Security/">Microsoft.Owin.Security</a>:</strong> Biblioteca que contem tipos comuns relacionados a autenticação;</li>
  <li><strong><a href="https://www.nuget.org/packages/Microsoft.Owin.Security.OAuth">Microsoft.Owin.Security.OAuth</a>:</strong> Biblioteca que contem tipos comuns relacionados a autenticação OAuth;</li>
  <li><strong><a href="https://www.nuget.org/packages/newtonsoft.json/">Newtonsoft.Json</a>:</strong> Biblioteca JSON de alta performance;</li>
  <li><strong><a href="https://www.nuget.org/packages/Owin/">Owin</a>:</strong> Biblioteca de interface de inicialização;</li>
  <li><strong><a href="https://www.nuget.org/packages/Strathweb.CacheOutput.WebApi2/">Strathweb.CacheOutput.WebApi2</a>:</strong> Biblioteca que cuida do cache do lado do servidor semelhante ao OutputCache do MVC;</li>
  <li><strong><a href="https://www.nuget.org/packages/Unity/">Unity</a>:</strong> Biblioteca de injeção de dependências.</li>
</ul>

<p>Agora que você conheceu um pouco de cada uma das biliotecas, vamos iniciar a instalação em nosso projeto. Será necessário utilizar o Nuget no Visual Studio para inclusão das bibliotecas.</p>

<p>Existem 2 formar de incluir as bibliotecas pelo Nuget. Uma é usando o <strong>Package Manager Console</strong> e a outra é o <strong>Manage Nuget Package for Solution</strong>. Eu prefiro o segundo, porem como forma de aprendizado e para agilizar, vou fazer da primeira forma pois assim passo as linhas de comando para incluir as biblioteca.</p>

<p><img src="https://raphaelcardoso.com.br/wp-content/uploads/2015/06/criando_e_consumindo_webapi_003.png" alt="criando_e_consumindo_webapi_003" /></p>

<p>Abra o <strong>Package Manager Console</strong> e digite as linhas abaixo ou simplesmente copie e cole.</p>

<p>[code=’powershell’] Install-Package DotNetZip Install-Package Microsoft.AspNet.Cors Install-Package Microsoft.AspNet.WebApi.Client Install-Package Microsoft.AspNet.WebApi.Core Install-Package Microsoft.AspNet.WebApi.Owin Install-Package Microsoft.Bcl Install-Package Microsoft.Bcl.Build Install-Package Microsoft.Bcl.Compression Install-Package Microsoft.Net.Http Install-Package Microsoft.Owin Install-Package Microsoft.Owin.Cors Install-Package Microsoft.Owin.Host.SystemWeb Install-Package Microsoft.Owin.Security Install-Package Microsoft.Owin.Security.OAuth Install-Package Newtonsoft.Json Install-Package Owin Install-Package Strathweb.CacheOutput.WebApi2 Install-Package Unity [/code]</p>

<p>Após copiar as linhas acima e colocar teremos todas as bibliotecas e suas dependências adicionas.</p>

<p><img src="https://raphaelcardoso.com.br/wp-content/uploads/2015/06/criando_e_consumindo_webapi_004.png" alt="criando_e_consumindo_webapi_004" /></p>

<p>Para que possamos começar a utilizar nosso ASP.NEt Web API e começar implementar as rotas, é preciso criar a classe de Startup que será responsável por inicializar as configurações da API. Na raiz do nosso projeto, crie uma nova classe chamada <strong>Startup.cs</strong>. Para isso clique com o botão direto em cima do Projeto e clique em <em>Add &gt; Class</em>.</p>

<p><img src="https://raphaelcardoso.com.br/wp-content/uploads/2015/06/criando_e_consumindo_webapi_005.png" alt="criando_e_consumindo_webapi_005" /></p>

<p>A classe criada terá o código abaixo:</p>

<p>[code=’csharp’] using Newtonsoft.Json; using Newtonsoft.Json.Serialization; using Owin; using System.Web.Http; [/code] [code=’csharp’] public class Startup { public void Configuration(IAppBuilder app) { HttpConfiguration config = new HttpConfiguration(); var formatters = config.Formatters; formatters.Remove(formatters.XmlFormatter); var jsonSettings = formatters.JsonFormatter.SerializerSettings; jsonSettings.Formatting = Formatting.Indented; jsonSettings.ContractResolver = new CamelCasePropertyNamesContractResolver(); formatters.JsonFormatter.SerializerSettings.PreserveReferencesHandling = Newtonsoft.Json.PreserveReferencesHandling.Objects; config.MapHttpAttributeRoutes(); config.Routes.MapHttpRoute( name: “DefaultRoute”, routeTemplate: “api/{controller}/{id}”, defaults: new { id = RouteParameter.Optional } ); app.UseCors(Microsoft.Owin.Cors.CorsOptions.AllowAll); app.UseWebApi(config); } } [/code]</p>

<p>O que esse código faz é, remover o formato XML e adicionar o formato JSON alem de definir nossa mapa da rota.</p>

<p>Crie uma nova pasta na raiz do projeto com o nome de <strong>Controllers</strong>. É nessa pasta que adicionaremos nossos controllers.</p>

<p>Clique com o botão direito em cima da pasta criada e clique em <em>Add &gt; Controller</em>.</p>

<p><img src="https://raphaelcardoso.com.br/wp-content/uploads/2015/06/criando_e_consumindo_webapi_006.png" alt="criando_e_consumindo_webapi_006" /></p>

<p>Na nova janela, escolha o Scaffold <strong>Web API 2 Controller - Empty</strong>.</p>

<p><img src="https://raphaelcardoso.com.br/wp-content/uploads/2015/06/criando_e_consumindo_webapi_007.png" alt="criando_e_consumindo_webapi_007" /></p>

<p>Defina um nome para o seu controller. Sugiro colocar o nome como <em>DefaultController</em>.</p>

<p><img src="https://raphaelcardoso.com.br/wp-content/uploads/2015/06/criando_e_consumindo_webapi_008.png" alt="criando_e_consumindo_webapi_008" /></p>

<p>Com o controller criado, criaremos então alguns métodos para nosso controller e definiremos as rotas.</p>

<p>Defina o RoutePrefix para o Controller, ficando conforme código abaixo.</p>

<p>[code=’csharp’] [RoutePrefix(“api/meuprojeto”)] public class DefaultController : ApiController { } [/code]</p>

<p>O exemplo acima estabelecemos que quando for chamado a url com o prefixo <strong>api/meuprojeto</strong>, será direcionado para esse controller que acabamos de criar.</p>

<p>Agora crie o método abaixo dentro do controller.</p>

<p>[code=’csharp’] [RoutePrefix(“api/meuprojeto”)] public class DefaultController : ApiController { [HttpGet] [Route(“datahora/consulta”)] public HttpResponseMessage GetDataHoraServidor() { try { var dataHora = DateTime.Now.ToString(“dd/MM/yyyy HH:mm:ss”); return Request.CreateResponse(HttpStatusCode.OK, dataHora); } catch (Exception ex) { return Request.CreateResponse(HttpStatusCode.BadRequest, ex.Message); } } } [/code]</p>

<p>Como pode ver no exemplo, criamos um método do tipo <em>HttpGet</em> com a rota <em>datahora/consulta</em> que no final, quando formos chamar-la no browser, chamaremos pela url <em>http://{servidor}/api/meuprojeto/datahora/consulta</em>.</p>

<p><img src="https://raphaelcardoso.com.br/wp-content/uploads/2015/06/criando_e_consumindo_webapi_009.png" alt="criando_e_consumindo_webapi_009" /></p>

<p>Podemos também criar um método utilizando-se do uso de parâmetros para consulta.</p>

<p>[code=’csharp’] [HttpGet] [Route(“consulta/cliente/{id:int}”)] public HttpResponseMessage GetClientePorId(int id) { try { var clientes = new[] { new { Id = 1, Nome = “Pedro”, DataNascimento = new DateTime(1954, 2, 1) }, new { Id = 2, Nome = “Paulo”, DataNascimento = new DateTime(1944, 4, 12) }, new { Id = 3, Nome = “Fernando”, DataNascimento = new DateTime(1963, 5, 9) }, new { Id = 4, Nome = “Maria”, DataNascimento = new DateTime(1984, 4, 30) }, new { Id = 5, Nome = “João”, DataNascimento = new DateTime(1990, 3, 14) }, new { Id = 6, Nome = “Joana”, DataNascimento = new DateTime(1974, 6, 19) } }; var cliente = clientes.Where(x =&gt; x.Id == id).FirstOrDefault(); if (cliente == null) throw new Exception(“Cliente não encontrado”); return Request.CreateResponse(HttpStatusCode.OK, cliente); } catch (Exception ex) { return Request.CreateResponse(HttpStatusCode.BadRequest, ex.Message); } } [/code]</p>

<p>No exemplo criamos um novo método que recebe um parâmetro do tipo <em>int</em>, que é do tipo <em>HttpGet</em> que possui a rota <em>consulta/cliente/{id:int}</em>. Quando for chamar no browser essa url, chamaremos pela url <em>http://{servidor}/api/meuprojeto/consulta/cliente/{id}</em>, onde {id} é o id que queremos consultar.</p>

<p><img src="https://raphaelcardoso.com.br/wp-content/uploads/2015/06/criando_e_consumindo_webapi_010.png" alt="criando_e_consumindo_webapi_010" /></p>

<p>Ainda no exemplo, caso passemos um id que não existe, iremos acionar um Exception que por sua vez cairá na tratativa do <em>try catch</em> e retornará um <em>BadRequest</em>.</p>

<p><img src="https://raphaelcardoso.com.br/wp-content/uploads/2015/06/criando_e_consumindo_webapi_0111.png" alt="criando_e_consumindo_webapi_011" /></p>

<p>Até aqui fizemos alguns exemplos de <em>HttpGet</em>, agora vou exemplificar como fazer uso do <em>HttpPost</em> para submeter objetivos mais complexos.</p>

<p>Primeiro criaremos a classe <em>Cliente</em>.</p>

<p>[code=’csharp’] public class Cliente { public string Nome { get; set; } } [/code]</p>

<p>E agora criaremos o nosso método de <em>HttpPost</em>.</p>

<p>[code=’csharp’] [HttpPost] [Route(“cadastrar”)] public HttpResponseMessage PostCadastro(Cliente cliente) { try { return Request.CreateResponse(HttpStatusCode.OK, “Cadastro do usuário “ + cliente.Nome + “ realizado.”); } catch (Exception ex) { return Request.CreateResponse(HttpStatusCode.BadRequest, ex.Message); } } [/code]</p>

<p>No exemplo criamos um novo método que não recebe nenhum parâmetro pela url como ocorre com os HttpGet. Nesse caso, os dados precisam ser submetidos para a url e nesse caso vou testar usando o aplicativo <a href="https://chrome.google.com/webstore/detail/postman/fhbjgbiflinjbdggehcddcbncdddomop">Postman</a> para o Google Chrome.</p>

<p>Para testar, abra o Postman e selecione o tipo de requisição. No caso usaremos o <em>Post</em>. Informe a url, selecione o formato <em>raw</em> e o tipo de dados a ser submetido como <em>JSON (application/json)</em> e informe o JSON.</p>

<p>[code=’javascript’] { “Nome”:”Raphael Cardoso” } [/code] <img src="https://raphaelcardoso.com.br/wp-content/uploads/2015/06/criando_e_consumindo_webapi_012.png" alt="criando_e_consumindo_webapi_012" /></p>

<p>Você aprendeu de forma simples a criação de uma Web API. Poderá tranquilamente explorar o que foi passado criando novos métodos que recebam parametros diferentes ou até mesmo que utilize de objetos mais complexos ao realizar um HttpPost.</p>

<p>Na próxima parte, veremos como utilizar de conexão com banco de dados em nossa Web API e possibilitar realização de CRUD (Create, Read, Update, Delete).</p>

<p>Em caso de dúvida, utilize os comentários ou publique sua dúvida no fórum.</p>

<p>Fonte do projeto: <a href="https://github.com/csharpbrasil/AspNetWebApi">Github</a>.</p>

<p>Abraço e até a próxima!</p>

		
	</div>
</article>


      </main>		
      <!-- Pagination links -->
      
	  </div>
    
    <!-- Footer -->
    <footer class="footer"><span>&copy; 2024 C# Brasil. Todos os direitos reservados | Versão: 1.0.0 </span></footer>
    <!-- Script -->
    <script src="/js/main.js"></script>	

	</div>
</body>
</html>
