<!DOCTYPE html>
<html>

<head>
	<!-- Meta -->
	<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="C# Brasil">

	<title>Criando e consumindo Web API – Parte 2</title>

	<!-- CSS & fonts -->
	<link rel="stylesheet" href="/css/main.css?1716937206294534819">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,300,600,800" rel="stylesheet" type="text/css">

    <link rel="shortcut icon" href="/images/favicon.png" />
</head>


<body>
	<div id="wrap">
	  	
    <!-- Navigation -->
    <nav id="nav">
	<div id="nav-list">
		<a href="http://localhost:4000/">Página inicial</a>
		<a href="http://localhost:4000/sobre">Sobre o blog</a>
	</div>
</nav>

    
    <!-- Icon menu -->
	  <a id="nav-menu">
	  	<div id="menu"></div>
	  </a>
    <!-- Header -->
    <header id="header">
	<a href="http://localhost:4000/">
		<img src="/images/logo_csharpbrasil.png" class="logo" alt="C# Brasil">
	</a>
</header>

    <!-- Main content -->
	  <div id="container">
      <main>
        <article id="post-page">
	<h2>Criando e consumindo Web API – Parte 2</h2>		
	<time datetime="2015-06-29T07:30:38-03:00" class="by-line">
		
		29
		Junho
		  
		2015
	</time>
	<div class="content">

		<p>Dando continuidade a série de artigo <a href="https://raphaelcardoso.com.br/tags/desenvolvimento-web-api/">Criando e consumindo Web API</a>, onde na <a href="https://raphaelcardoso.com.br/criando-e-consumindo-web-api-parte-1/">primeira parte</a> fiz uma abordagem superficial do que é uma Web API e como cria-la. Nessa segunda parte, abordaremos o uso de conexão com banco de dados para efetuar o CRUD (Create, Read, Update, Delete). Para isso, não irei utilizar o Entity Framework de inicio. Isso ficará para uma nova parte dessa série. A principio a ideia é mostrar o funcionamento de uma Web API.</p>

<p>Então para dar inicio, faça o download do fonte do artigo disponivel no <a href="https://github.com/csharpbrasil/AspNetWebApi">Github</a> se já não fez pois iremos utiliza-lo como base para o desenvolvimento dessa segunda parte. Somente para rever o que foi feito na primeira parte, nós criamos no projeto anterior 3 métodos, sendo um para retornar a data e hora do servidor, outro para realizar o filtro de clientes pelo código e outro para realizar o envio de dados de um cliente.</p>

<p>Vamos descartar esses métodos que criamos e vamos criar alguns outros métodos novos e definir as suas rotas. Para esse exemplo utilizaremos SQL Server. Não irei me aprofundar em como criar o banco, simplesmente vou deixar aqui meu script para criar a tabela de clientes.</p>

<p>Abra seu <em>SQL Manager</em> e crie a tabela utilizando o script sql abaixo.</p>

<p>[code=’sql’] CREATE TABLE CLIENTES ( ID INT IDENTITY(1, 1) NOT NULL, NOME VARCHAR(60) NOT NULL, DATA_NASCIMENTO DATETIME NOT NULL, EMAIL VARCHAR(150) NULL, CONSTRAINT PK_CLIENTES PRIMARY KEY (ID) ) GO [/code]</p>

<p>Agora vamos incluir alguns registros iniciais para nossos testes.</p>

<p>[code=’sql’] INSERT INTO clientes([nome],[data_nascimento],[email]) VALUES(‘Elliott V. Sears’,’1971/09/12’,’ut.ipsum.ac@Aliquam.net’) INSERT INTO clientes([nome],[data_nascimento],[email]) VALUES(‘Jayme A. Woods’,’1964/02/14’,’nascetur.ridiculus@Curae.net’) INSERT INTO clientes([nome],[data_nascimento],[email]) VALUES(‘Leo K. Small’,’1988/05/12’,’a.sollicitudin.orci@atpede.net’) INSERT INTO clientes([nome],[data_nascimento],[email]) VALUES(‘Winter Z. Collier’,’1991/10/15’,’consectetuer.adipiscing@Phasellusfermentum.net’) INSERT INTO clientes([nome],[data_nascimento],[email]) VALUES(‘Andrew P. Rivera’,’1966/11/03’,’dictum@pretium.net’) INSERT INTO clientes([nome],[data_nascimento],[email]) VALUES(‘Brenda B. Acevedo’,’1972/05/17’,’natoque.penatibus@Integervulputate.com’) INSERT INTO clientes([nome],[data_nascimento],[email]) VALUES(‘Carlos Z. Velez’,’1971/03/19’,’Suspendisse.tristique.neque@turpis.ca’) INSERT INTO clientes([nome],[data_nascimento],[email]) VALUES(‘Herrod Z. Flores’,’1951/12/24’,’imperdiet.non.vestibulum@Nunc.net’) INSERT INTO clientes([nome],[data_nascimento],[email]) VALUES(‘Willow U. Simon’,’1967/11/23’,’urna.suscipit@felisullamcorper.co.uk’) INSERT INTO clientes([nome],[data_nascimento],[email]) VALUES(‘Oliver F. Pickett’,’1948/02/19’,’mollis.dui.in@id.com’) [/code]</p>

<p>A primeira coisa a fazer é criar uma nova pasta chamada <em>Models</em> na raiz do nosso projeto. Essa pasta irá conter a classe <em>Cliente</em> que criaremos agora.</p>

<p>Clique sobre a pasta com o botão direito e escolha <em>Add &gt; Class</em>.</p>

<p><img src="https://raphaelcardoso.com.br/wp-content/uploads/2015/06/criando_e_consumindo_webapi_0011.png" alt="criando_e_consumindo_webapi_001" /></p>

<p>E defina o nome para a classe como <em>Cliente.cs</em>.</p>

<p><img src="https://raphaelcardoso.com.br/wp-content/uploads/2015/06/criando_e_consumindo_webapi_0021.png" alt="criando_e_consumindo_webapi_002" /></p>

<p>Com a classe <em>Cliente</em> criada, vamos incluir algumas propriedades.</p>

<p>[code=’csharp’] public class Cliente { public int Id { get; set; } public string Nome { get; set; } public DateTime DataNascimento { get; set; } public string Email { get; set; } } [/code]</p>

<p>Agora com a nossa classe Cliente criada, vamos alterar o nosso controller. Na primeira parte havíamos criado o controller chamado <em>DefaultController</em> e é nele que vamos criar os nossos métodos.</p>

<p>Primeiramente, criamos a variável para a <em>ConnectionString</em> que vamos utilizar.</p>

<p>[code=’csharp’] private string ConnectionString = “Data Source=;User Id=;Password=;Initial Catalog=”; [/code]</p>

<p>Criado a ConnectionString, podemos já incluir o nosso primeiro método que será responsável por trazer todos os clientes cadastrados.</p>

<p>[code=’csharp’] [HttpGet] [Route(“clientes/todos”)] public HttpResponseMessage GetAll() { try { List lstClientes = new List(); using (SqlConnection connection = new SqlConnection(this.ConnectionString)) { connection.Open(); using (SqlCommand command = new SqlCommand()) { command.Connection = connection; command.CommandText = “select id, nome, data_nascimento, email from clientes”; SqlDataReader reader = command.ExecuteReader(); while (reader.Read()) { Cliente cliente = new Cliente() { Id = reader[“id”] == DBNull.Value ? 0 : Convert.ToInt32(reader[“id”]), Nome = reader[“nome”] == DBNull.Value ? string.Empty : reader[“nome”].ToString(), DataNascimento = reader[“data_nascimento”] == DBNull.Value ? DateTime.MinValue : Convert.ToDateTime(reader[“data_nascimento”]), Email = reader[“email”] == DBNull.Value ? string.Empty : reader[“email”].ToString() }; lstClientes.Add(cliente); } } connection.Close(); } return Request.CreateResponse(HttpStatusCode.OK, lstClientes.ToArray()); } catch (Exception ex) { return Request.CreateResponse(HttpStatusCode.BadRequest, ex.Message); } } [/code]</p>

<p>Explicando o código acima, na linha 07 temos declarado a lista onde incluiremos os clientes retornados do banco e que será retornado pela API quando foi feito o <em>HttpGet</em>. Da linha 09 até a linha 35 é a parte onde realizamos a consulta no banco, incluímos o resultado na lista para depois retornar o Array dessa lista na resposta da API na linha 37.</p>

<p>Utilizando o <a href="https://chrome.google.com/webstore/detail/postman/fhbjgbiflinjbdggehcddcbncdddomop">Postman</a> que citei no <a href="https://raphaelcardoso.com.br/criando-e-consumindo-web-api-parte-1">artigo anterior</a>, poderemos fazer o teste de nossa API.</p>

<p><img src="https://raphaelcardoso.com.br/wp-content/uploads/2015/06/criando_e_consumindo_webapi_0031.png" alt="criando_e_consumindo_webapi_003" /></p>

<p>No caso do HttpGet, podemos fazer o mesmo teste diretamente no browser.</p>

<p><img src="https://raphaelcardoso.com.br/wp-content/uploads/2015/06/criando_e_consumindo_webapi_0041.png" alt="criando_e_consumindo_webapi_004" /></p>

<p>Para realizar a consulta de um cliente especifico, criaremos um método também de <em>HttpGet</em>, porem esse passaremos o <em>id</em>. Basicamente ele faz quase as mesmas coisa que o anterior, porem ele irá retornar um simples objeto ao invés de uma lista.</p>

<p>[code=’csharp’] [HttpGet] [Route(“cliente/{id:int}”)] public HttpResponseMessage GetById(int id) { try { Cliente cliente = null; using (SqlConnection connection = new SqlConnection(this.ConnectionString)) { connection.Open(); using (SqlCommand command = new SqlCommand()) { command.Connection = connection; command.CommandText = “select id, nome, data_nascimento, email from clientes where id = @id”; command.Parameters.AddWithValue(“id”, id); SqlDataReader reader = command.ExecuteReader(); while (reader.Read()) { cliente = new Cliente() { Id = reader[“id”] == DBNull.Value ? 0 : Convert.ToInt32(reader[“id”]), Nome = reader[“nome”] == DBNull.Value ? string.Empty : reader[“nome”].ToString(), DataNascimento = reader[“data_nascimento”] == DBNull.Value ? DateTime.MinValue : Convert.ToDateTime(reader[“data_nascimento”]), Email = reader[“email”] == DBNull.Value ? string.Empty : reader[“email”].ToString() }; } } connection.Close(); } return Request.CreateResponse(HttpStatusCode.OK, cliente); } catch (Exception ex) { return Request.CreateResponse(HttpStatusCode.BadRequest, ex.Message); } } [/code]</p>

<p>Executando, teremos os seguintes resultados.</p>

<p><img src="https://raphaelcardoso.com.br/wp-content/uploads/2015/06/criando_e_consumindo_webapi_0051.png" alt="criando_e_consumindo_webapi_005" /> <img src="https://raphaelcardoso.com.br/wp-content/uploads/2015/06/criando_e_consumindo_webapi_0061.png" alt="criando_e_consumindo_webapi_006" /></p>

<p>Agora vem a parte interessante do Web API. Criaremos um novo método para excluir o cliente utilizando o <em>HttpDelete</em> informando o <em>id</em>.</p>

<p>Você vai reparar que a rota para consultar o cliente é a mesma de excluir, ou seja, ambas são <em>http://{servidor}/api/meuprojeto/cliente/{id}</em>. Isso pelo de os métodos possuírem as operações diferentes, ou seja, um é <em>HttpGet</em> e o outro é <em>HttpDelete</em>.</p>

<p>[code=’csharp’] [HttpDelete] [Route(“cliente/{id:int}”)] public HttpResponseMessage DeleteById(int id) { try { bool resultado = false; using (SqlConnection connection = new SqlConnection(this.ConnectionString)) { connection.Open(); using (SqlCommand command = new SqlCommand()) { command.Connection = connection; command.CommandText = “delete from clientes where id = @id”; command.Parameters.AddWithValue(“id”, id); int i = command.ExecuteNonQuery(); resultado = i &gt; 0; } connection.Close(); } return Request.CreateResponse(HttpStatusCode.OK, resultado); } catch (Exception ex) { return Request.CreateResponse(HttpStatusCode.BadRequest, ex.Message); } } [/code]</p>

<p>Na linha 26, repare que estou passando o resultado do tipo <em>boolean</em>. Assim saberei se o meu registro foi excluído ou não. Caso exista o registro e consiga excluir retorna <em>true</em>, senão retornará <em>false</em>.</p>

<p><img src="https://raphaelcardoso.com.br/wp-content/uploads/2015/06/criando_e_consumindo_webapi_0071.png" alt="criando_e_consumindo_webapi_007" /></p>

<p>Outra situação que merece atenção é com a criação de duas ou mais rotar iguais com o mesmo tipo de operação. Isso levará a ocorrer um <em>InvalidOperationException</em>. Então já sabe, ocorrer esse Exception, confira as rotas e operações.</p>

<p><img src="https://raphaelcardoso.com.br/wp-content/uploads/2015/06/criando_e_consumindo_webapi_0081.png" alt="criando_e_consumindo_webapi_008" /></p>

<p>Já temos em nossa Web API a possibilidade de consultar com <em>HttpGet</em> e excluir <em>HttpDelete</em>. Agora vamos criar a opção de cadastrar usando o <em>HttpPost</em>. Nessa caso iremos submeter os dados para que sejam gravados, ou seja, os dados serão enviados no corpo do Http no formato jSON. Esse jSON deverá estar no formato de nosso objeto do parâmetro do método da Web API.</p>

<p>[code=’csharp’] [HttpPost] [Route(“cliente”)] public HttpResponseMessage Post(Cliente cliente) { try { bool resultado = false; if (cliente == null) throw new ArgumentNullException(“cliente”); using (SqlConnection connection = new SqlConnection(this.ConnectionString)) { connection.Open(); using (SqlCommand command = new SqlCommand()) { command.Connection = connection; command.CommandText = “insert into clientes(nome, data_nascimento, email) values(@nome, @data_nascimento, @email)”; command.Parameters.AddWithValue(“nome”, cliente.Nome); command.Parameters.AddWithValue(“data_nascimento”, cliente.DataNascimento); command.Parameters.AddWithValue(“email”, cliente.Email); int i = command.ExecuteNonQuery(); resultado = i &gt; 0; } connection.Close(); } return Request.CreateResponse(HttpStatusCode.OK, resultado); } catch (Exception ex) { return Request.CreateResponse(HttpStatusCode.BadRequest, ex.Message); } } [/code]</p>

<p>Analisando o método de Post, veja que logo na linha 09 estamos verificando se os dados passados são nulos. Caso seja nulo, um Exception será acionado o que irá retornar um <em>BadRequest</em> pela linha 35. Em caso de sucesso, um resultado do tipo boolean será retornado na linha 31.</p>

<p>Para executar o Post pelo <em>Postman</em>, passaremos o tipo de operação que no caso será POST, a url e o tipo de dados JSON. É importante destacar que o JSON deve respeitar o formato do objeto do parâmetro do método. No caso o parâmetro é o objeto Cliente e deverá estar no formato abaixo.</p>

<p>[code=’javascript’] { “Nome”:”Seu nome aqui”, “DataNascimento”:”1980-01-01T00:00:00”, “Email”:”seuemail@servidor.com” } [/code]</p>

<p>Caso você não informe esse JSON, será retornado o erro de parâmetro nulo conforme foi citado anteriormente.</p>

<p>Informando os dados corretamente, será retornado true em caso de sucesso na inclusão.</p>

<p><img src="https://raphaelcardoso.com.br/wp-content/uploads/2015/06/criando_e_consumindo_webapi_0091.png" alt="criando_e_consumindo_webapi_009" /></p>

<p>Se consultarmos todos os clientes, veremos nosso registro incluso.</p>

<p><img src="https://raphaelcardoso.com.br/wp-content/uploads/2015/06/criando_e_consumindo_webapi_0101.png" alt="criando_e_consumindo_webapi_010" /></p>

<p>Poderemos também realizar a consulta passando o Id do cliente e também retornará o registro incluso.</p>

<p><img src="https://raphaelcardoso.com.br/wp-content/uploads/2015/06/criando_e_consumindo_webapi_011.png" alt="criando_e_consumindo_webapi_011" /></p>

<p>Já podemos consultar, incluir e excluir os registro, agora faremos o que irá atualizar os dados. Nesse caso usaremos a operação <em>HttpPut</em>. O método irá receber o id do cliente e o objeto cliente com os dados da mesma forma que submetemos no Post para inclusão.</p>

<p>[code=’csharp’] [HttpPut] [Route(“cliente/{id:int}”)] public HttpResponseMessage Put(int id, Cliente cliente) { try { bool resultado = false; if (cliente == null) throw new ArgumentNullException(“cliente”); if (id == 0) throw new ArgumentNullException(“id”); using (SqlConnection connection = new SqlConnection(this.ConnectionString)) { connection.Open(); using (SqlCommand command = new SqlCommand()) { command.Connection = connection; command.CommandText = “update clientes set nome = @nome, data_nascimento = @data_nascimento, email = @email where id = @id”; command.Parameters.AddWithValue(“id”, id); command.Parameters.AddWithValue(“nome”, cliente.Nome); command.Parameters.AddWithValue(“data_nascimento”, cliente.DataNascimento); command.Parameters.AddWithValue(“email”, cliente.Email); int i = command.ExecuteNonQuery(); resultado = i &gt; 0; } connection.Close(); } return Request.CreateResponse(HttpStatusCode.OK, resultado); } catch (Exception ex) { return Request.CreateResponse(HttpStatusCode.BadRequest, ex.Message); } } [/code]</p>

<p>A diferença desse método para o de <em>Post</em> é que esse está realizando o <em>UPDATE</em> do registro e verificando se o <em>Id</em> informado é maior que zero.</p>

<p><img src="https://raphaelcardoso.com.br/wp-content/uploads/2015/06/criando_e_consumindo_webapi_0121.png" alt="criando_e_consumindo_webapi_012" /></p>

<p>Nesse artigo você pode ver como criar um simples CRUD no Web API. Com o que viu até aqui é possível ampliar mais a funcionalidade utilizando até mesmo ORM como o <em>Entity Framework</em> e <em>NHibernate</em>.</p>

<p>Em caso de dúvida, utilize os comentários ou publique sua dúvida no fórum.</p>

<p>Fonte do projeto: <a href="https://github.com/csharpbrasil/AspNetWebApi">Github</a>.</p>

<p>Abraço e até a próxima!</p>

		
	</div>
</article>


      </main>		
      <!-- Pagination links -->
      
	  </div>
    
    <!-- Footer -->
    <footer class="footer"><span>&copy; 2024 C# Brasil. Todos os direitos reservados | Versão: 1.0.0 </span></footer>
    <!-- Script -->
    <script src="/js/main.js"></script>	

	</div>
</body>
</html>
